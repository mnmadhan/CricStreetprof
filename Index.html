<!DOCTYPE html>
<html lang="en">
<head>
    <base target="_self">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Cricket Scorer</title>
    <meta name="description" content="Comprehensive cricket scoring system for professional and street cricket">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .active-player {
            background-color: #e5e7eb;
            font-weight: 600;
        }
        .ball-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
        }
        .ball-0 { background-color: #6b7280; }
        .ball-1 { background-color: #10b981; }
        .ball-2 { background-color: #3b82f6; }
        .ball-3 { background-color: #f59e0b; }
        .ball-4 { background-color: #8b5cf6; }
        .ball-6 { background-color: #ec4899; }
        .ball-w { background-color: #ef4444; }
        .ball-wd { background-color: #f97316; border: 1px solid #c2410c; }
        .ball-nb { background-color: #f43f5e; border: 1px solid #be123c; }
        .ball-b { background-color: #14b8a6; border: 1px solid #0d9488; }
        .ball-lb { background-color: #a855f7; border: 1px solid #7e22ce; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <header class="bg-blue-800 text-white py-4 shadow-md">
        <div class="container mx-auto px-4">
            <h1 class="text-2xl font-bold">Professional Cricket Scorer</h1>
            <p class="text-sm opacity-80">Complete scoring system for professional and street cricket</p>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <!-- Match Setup Section -->
        <section id="setup-section" class="mb-8 bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Match Configuration</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Team 1 Configuration -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-medium mb-3 text-lg">Team 1</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Team Name</label>
                        <input type="text" id="team1-name" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Team 1">
                    </div>
                    
                    <div class="mb-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Players</label>
                        <div id="team1-players" class="space-y-2">
                            <div class="flex gap-2 items-center">
                                <input type="text" class="flex-1 px-3 py-2 border border-gray-300 rounded-md" placeholder="Player name">
                                <div class="flex items-center gap-2">
                                    <label class="text-xs text-gray-500">WK</label>
                                    <input type="checkbox" class="wicketkeeper">
                                </div>
                                <button class="remove-player px-2 py-1 bg-red-100 text-red-700 rounded-md text-sm">×</button>
                            </div>
                        </div>
                        <button id="add-team1-player" class="mt-2 px-3 py-1 bg-gray-100 text-gray-700 rounded-md text-sm hover:bg-gray-200">
                            <i class="fas fa-plus mr-1"></i> Add Player
                        </button>
                    </div>
                </div>

                <!-- Team 2 Configuration -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-medium mb-3 text-lg">Team 2</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Team Name</label>
                        <input type="text" id="team2-name" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Team 2">
                    </div>
                    
                    <div class="mb-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Players</label>
                        <div id="team2-players" class="space-y-2">
                            <div class="flex gap-2 items-center">
                                <input type="text" class="flex-1 px-3 py-2 border border-gray-300 rounded-md" placeholder="Player name">
                                <div class="flex items-center gap-2">
                                    <label class="text-xs text-gray-500">WK</label>
                                    <input type="checkbox" class="wicketkeeper">
                                </div>
                                <button class="remove-player px-2 py-1 bg-red-100 text-red-700 rounded-md text-sm">×</button>
                            </div>
                        </div>
                        <button id="add-team2-player" class="mt-2 px-3 py-1 bg-gray-100 text-gray-700 rounded-md text-sm hover:bg-gray-200">
                            <i class="fas fa-plus mr-1"></i> Add Player
                        </button>
                    </div>
                </div>
            </div>

            <!-- Match Settings -->
            <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Overs per innings</label>
                    <input type="number" id="total-overs" min="1" max="50" value="20" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Match Type</label>
                    <select id="match-type" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="limited">Limited Overs</option>
                        <option value="test">Test Match</option>
                        <option value="t20">T20</option>
                        <option value="street">Street Cricket</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Powerplay Overs</label>
                    <input type="number" id="powerplay-overs" min="0" max="20" value="6" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
            </div>

            <div class="mt-6 flex gap-4">
                <button id="start-match" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                    <i class="fas fa-play mr-2"></i> Start Match
                </button>
                <button id="load-match" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                    <i class="fas fa-folder-open mr-2"></i> Load Match
                </button>
            </div>
        </section>

        <!-- Match Control Section -->
        <section id="match-section" class="hidden bg-white p-6 rounded-lg shadow">
            <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                <h2 class="text-xl font-semibold text-gray-800">Match in Progress</h2>
                <div class="flex items-center gap-4">
                    <div class="text-sm bg-gray-100 px-3 py-1 rounded-full">
                        <span id="current-innings">1st Innings</span> | 
                        <span id="score-display">0/0 (0.0)</span>
                    </div>
                    <div class="text-sm bg-gray-100 px-3 py-1 rounded-full">
                        RR: <span id="run-rate">0.00</span> | 
                        RRR: <span id="req-rate">-</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Batting Team -->
                <div class="bg-gray-50 p-4 rounded-lg lg:col-span-2">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-medium">Batting: <span id="batting-team-name" class="font-semibold">Team 1</span></h3>
                        <div class="text-sm">
                            Partnership: <span id="partnership-runs">0</span> (<span id="partnership-balls">0</span>)
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-2">Batsman</th>
                                    <th class="text-right py-2">R</th>
                                    <th class="text-right py-2">B</th>
                                    <th class="text-right py-2">4s</th>
                                    <th class="text-right py-2">6s</th>
                                    <th class="text-right py-2">SR</th>
                                </tr>
                            </thead>
                            <tbody id="batting-team-players">
                                <!-- Batsmen will be added here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4">
                        <h4 class="font-medium mb-2">Fall of Wickets</h4>
                        <div id="fall-of-wickets" class="text-sm bg-gray-100 p-2 rounded-md">
                            <!-- Wicket falls will be added here -->
                        </div>
                    </div>
                </div>

                <!-- Bowling Team -->
                <div class="bg-gray-50 p-4 rounded-lg lg:col-span-1">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-medium">Bowling: <span id="bowling-team-name" class="font-semibold">Team 2</span></h3>
                        <div class="text-sm">
                            Current Over: <span id="current-over-display">0.0</span>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto mb-4">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-2">Bowler</th>
                                    <th class="text-right py-2">O</th>
                                    <th class="text-right py-2">M</th>
                                    <th class="text-right py-2">R</th>
                                    <th class="text-right py-2">W</th>
                                    <th class="text-right py-2">Econ</th>
                                </tr>
                            </thead>
                            <tbody id="bowling-team-players">
                                <!-- Bowlers will be added here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mb-4">
                        <h4 class="font-medium mb-2">Current Over</h4>
                        <div id="current-over-balls" class="flex flex-wrap gap-1 bg-gray-100 p-2 rounded-md">
                            <!-- Ball by ball will be added here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Score Controls -->
            <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Batsmen Selection -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Current Batsmen</label>
                        <div class="grid grid-cols-1 gap-2">
                            <div class="flex items-center gap-2">
                                <label class="w-16 text-sm">Striker:</label>
                                <select id="striker" class="flex-1 px-3 py-2 border border-gray-300 rounded-md"></select>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="w-16 text-sm">Non-striker:</label>
                                <select id="non-striker" class="flex-1 px-3 py-2 border border-gray-300 rounded-md"></select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Current Bowler</label>
                        <select id="current-bowler" class="w-full px-3 py-2 border border-gray-300 rounded-md"></select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fielding Position</label>
                        <select id="fielding-position" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="">Not specified</option>
                            <option value="slip">Slip</option>
                            <option value="gully">Gully</option>
                            <option value="point">Point</option>
                            <option value="cover">Cover</option>
                            <option value="mid-off">Mid-off</option>
                            <option value="mid-on">Mid-on</option>
                            <option value="mid-wicket">Mid-wicket</option>
                            <option value="square-leg">Square leg</option>
                            <option value="fine-leg">Fine leg</option>
                            <option value="third-man">Third man</option>
                            <option value="long-off">Long off</option>
                            <option value="long-on">Long on</option>
                        </select>
                    </div>
                </div>

                <!-- Runs and Extras -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Runs</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button class="run-btn px-3 py-2 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200" data-runs="0">0</button>
                            <button class="run-btn px-3 py-2 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200" data-runs="1">1</button>
                            <button class="run-btn px-3 py-2 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200" data-runs="2">2</button>
                            <button class="run-btn px-3 py-2 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200" data-runs="3">3</button>
                            <button class="run-btn px-3 py-2 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200" data-runs="4">4</button>
                            <button class="run-btn px-3 py-2 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200" data-runs="6">6</button>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Extras</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button class="extra-btn px-3 py-2 bg-yellow-100 text-yellow-700 rounded-md hover:bg-yellow-200" data-extra="wide">Wide</button>
                            <button class="extra-btn px-3 py-2 bg-yellow-100 text-yellow-700 rounded-md hover:bg-yellow-200" data-extra="noball">No Ball</button>
                            <button class="extra-btn px-3 py-2 bg-yellow-100 text-yellow-700 rounded-md hover:bg-yellow-200" data-extra="bye">Bye</button>
                            <button class="extra-btn px-3 py-2 bg-yellow-100 text-yellow-700 rounded-md hover:bg-yellow-200" data-extra="legbye">Leg Bye</button>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Commentary</label>
                        <input type="text" id="ball-commentary" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Add commentary for this ball">
                    </div>
                </div>

                <!-- Wickets and Controls -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Wickets</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button class="wicket-btn px-3 py-2 bg-red-100 text-red-700 rounded-md hover:bg-red-200" data-type="bowled">Bowled</button>
                            <button class="wicket-btn px-3 py-2 bg-red-100 text-red-700 rounded-md hover:bg-red-200" data-type="caught">Caught</button>
                            <button class="wicket-btn px-3 py-2 bg-red-100 text-red-700 rounded-md hover:bg-red-200" data-type="lbw">LBW</button>
                            <button class="wicket-btn px-3 py-2 bg-red-100 text-red-700 rounded-md hover:bg-red-200" data-type="runout">Run Out</button>
                            <button class="wicket-btn px-3 py-2 bg-red-100 text-red-700 rounded-md hover:bg-red-200" data-type="stumped">Stumped</button>
                            <button class="wicket-btn px-3 py-2 bg-red-100 text-red-700 rounded-md hover:bg-red-200" data-type="hitwicket">Hit Wicket</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <button id="undo-btn" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">
                            <i class="fas fa-undo mr-1"></i> Undo
                        </button>
                        <button id="end-innings" class="px-3 py-2 bg-orange-500 text-white rounded-md hover:bg-orange-600">
                            <i class="fas fa-flag mr-1"></i> End Innings
                        </button>
                    </div>
                    
                    <div class="mt-4">
                        <button id="change-strike" class="w-full px-3 py-2 bg-purple-100 text-purple-700 rounded-md hover:bg-purple-200">
                            <i class="fas fa-exchange-alt mr-1"></i> Change Strike
                        </button>
                    </div>
                    
                    <div class="mt-4">
                        <button id="change-bowler" class="w-full px-3 py-2 bg-green-100 text-green-700 rounded-md hover:bg-green-200">
                            <i class="fas fa-user-edit mr-1"></i> Change Bowler
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Match Summary Section -->
        <section id="summary-section" class="hidden bg-white p-6 rounded-lg shadow mt-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Match Summary</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Team 1 Summary -->
                <div>
                    <h3 class="font-medium text-lg mb-3"><span id="summary-team1-name">Team 1</span> Innings</h3>
                    <div class="overflow-x-auto mb-4">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-2">Batsman</th>
                                    <th class="text-right py-2">R</th>
                                    <th class="text-right py-2">B</th>
                                    <th class="text-right py-2">4s</th>
                                    <th class="text-right py-2">6s</th>
                                    <th class="text-right py-2">SR</th>
                                </tr>
                            </thead>
                            <tbody id="summary-team1-batting">
                                <!-- Team 1 batsmen summary -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-2">Bowler</th>
                                    <th class="text-right py-2">O</th>
                                    <th class="text-right py-2">M</th>
                                    <th class="text-right py-2">R</th>
                                    <th class="text-right py-2">W</th>
                                    <th class="text-right py-2">Econ</th>
                                </tr>
                            </thead>
                            <tbody id="summary-team2-bowling">
                                <!-- Team 2 bowlers summary -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Team 2 Summary -->
                <div>
                    <h3 class="font-medium text-lg mb-3"><span id="summary-team2-name">Team 2</span> Innings</h3>
                    <div class="overflow-x-auto mb-4">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-2">Batsman</th>
                                    <th class="text-right py-2">R</th>
                                    <th class="text-right py-2">B</th>
                                    <th class="text-right py-2">4s</th>
                                    <th class="text-right py-2">6s</th>
                                    <th class="text-right py-2">SR</th>
                                </tr>
                            </thead>
                            <tbody id="summary-team2-batting">
                                <!-- Team 2 batsmen summary -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-2">Bowler</th>
                                    <th class="text-right py-2">O</th>
                                    <th class="text-right py-2">M</th>
                                    <th class="text-right py-2">R</th>
                                    <th class="text-right py-2">W</th>
                                    <th class="text-right py-2">Econ</th>
                                </tr>
                            </thead>
                            <tbody id="summary-team1-bowling">
                                <!-- Team 1 bowlers summary -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Match Result -->
            <div class="mt-6 p-4 bg-gray-100 rounded-lg">
                <h3 class="font-medium mb-2">Result</h3>
                <p id="match-result" class="text-lg font-semibold"></p>
                <p id="match-summary" class="text-sm mt-1"></p>
            </div>

            <!-- Match Timeline -->
            <div class="mt-6">
                <h3 class="font-medium mb-2">Match Timeline</h3>
                <div id="match-timeline" class="bg-gray-50 p-3 rounded-md max-h-60 overflow-y-auto">
                    <!-- Match events will be added here -->
                </div>
            </div>

            <div class="mt-6 flex flex-wrap gap-4">
                <button id="new-match" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                    <i class="fas fa-plus mr-2"></i> New Match
                </button>
                <button id="save-match" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                    <i class="fas fa-save mr-2"></i> Save Match
                </button>
                <button id="export-match" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                    <i class="fas fa-file-export mr-2"></i> Export
                </button>
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-white py-4 mt-8">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>Professional Cricket Scorer &copy; 2023 | Track your cricket matches with precision</p>
        </div>
    </footer>

    <script>
        // Match data structure
        let matchData = {
            team1: {
                name: "",
                players: [],
                batting: [],
                bowling: [],
                totalRuns: 0,
                wickets: 0,
                overs: 0,
                balls: 0,
                extras: 0,
                wicketkeeper: ""
            },
            team2: {
                name: "",
                players: [],
                batting: [],
                bowling: [],
                totalRuns: 0,
                wickets: 0,
                overs: 0,
                balls: 0,
                extras: 0,
                wicketkeeper: ""
            },
            currentInnings: 1,
            totalOvers: 20,
            powerplayOvers: 6,
            matchType: "limited",
            history: [],
            timeline: [],
            matchStarted: false,
            matchEnded: false,
            currentOver: [],
            partnership: {
                runs: 0,
                balls: 0,
                batsman1: "",
                batsman2: ""
            }
        };

        // DOM elements
        const setupSection = document.getElementById('setup-section');
        const matchSection = document.getElementById('match-section');
        const summarySection = document.getElementById('summary-section');

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Check for saved match
            const savedMatch = localStorage.getItem('cricketMatchData');
            if (savedMatch) {
                try {
                    const parsedData = JSON.parse(savedMatch);
                    if (parsedData.matchStarted) {
                        matchData = parsedData;
                        if (matchData.matchEnded) {
                            showSummary();
                        } else {
                            startMatch();
                        }
                    }
                } catch (e) {
                    console.error("Error loading saved match:", e);
                }
            }

            // Setup event listeners
            setupEventListeners();
        });

        function setupEventListeners() {
            // Add player buttons
            document.getElementById('add-team1-player').addEventListener('click', () => addPlayer('team1'));
            document.getElementById('add-team2-player').addEventListener('click', () => addPlayer('team2'));

            // Start match button
            document.getElementById('start-match').addEventListener('click', startMatchSetup);

            // Load match button
            document.getElementById('load-match').addEventListener('click', loadMatch);

            // Run buttons
            document.querySelectorAll('.run-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    addRuns(parseInt(this.getAttribute('data-runs')));
                });
            });

            // Extra buttons
            document.querySelectorAll('.extra-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    addExtra(this.getAttribute('data-extra'));
                });
            });

            // Wicket buttons
            document.querySelectorAll('.wicket-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    addWicket(this.getAttribute('data-type'));
                });
            });

            // End innings button
            document.getElementById('end-innings').addEventListener('click', endInnings);

            // Undo button
            document.getElementById('undo-btn').addEventListener('click', undoLastAction);

            // New match button
            document.getElementById('new-match').addEventListener('click', resetMatch);

            // Save match button
            document.getElementById('save-match').addEventListener('click', saveMatch);

            // Export match button
            document.getElementById('export-match').addEventListener('click', exportMatch);

            // Change strike button
            document.getElementById('change-strike').addEventListener('click', rotateStrike);

            // Change bowler button
            document.getElementById('change-bowler').addEventListener('click', changeBowler);
        }

        function addPlayer(team) {
            const container = document.getElementById(`${team}-players`);
            const playerDiv = document.createElement('div');
            playerDiv.className = 'flex gap-2 items-center';
            playerDiv.innerHTML = `
                <input type="text" class="flex-1 px-3 py-2 border border-gray-300 rounded-md" placeholder="Player name">
                <div class="flex items-center gap-2">
                    <label class="text-xs text-gray-500">WK</label>
                    <input type="checkbox" class="wicketkeeper">
                </div>
                <button class="remove-player px-2 py-1 bg-red-100 text-red-700 rounded-md text-sm">×</button>
            `;
            container.appendChild(playerDiv);

            // Add event listener to remove button
            playerDiv.querySelector('.remove-player').addEventListener('click', function() {
                container.removeChild(playerDiv);
            });
        }

        function startMatchSetup() {
            // Get team names
            matchData.team1.name = document.getElementById('team1-name').value || 'Team 1';
            matchData.team2.name = document.getElementById('team2-name').value || 'Team 2';

            // Get players for team 1
            matchData.team1.players = [];
            matchData.team1.wicketkeeper = "";
            document.querySelectorAll('#team1-players .wicketkeeper').forEach((checkbox, index) => {
                const input = checkbox.parentElement.parentElement.querySelector('input[type="text"]');
                if (input.value.trim()) {
                    matchData.team1.players.push(input.value.trim());
                    if (checkbox.checked) {
                        matchData.team1.wicketkeeper = input.value.trim();
                    }
                }
            });

            // Get players for team 2
            matchData.team2.players = [];
            matchData.team2.wicketkeeper = "";
            document.querySelectorAll('#team2-players .wicketkeeper').forEach((checkbox, index) => {
                const input = checkbox.parentElement.parentElement.querySelector('input[type="text"]');
                if (input.value.trim()) {
                    matchData.team2.players.push(input.value.trim());
                    if (checkbox.checked) {
                        matchData.team2.wicketkeeper = input.value.trim();
                    }
                }
            });

            // Validate at least 2 players per team
            if (matchData.team1.players.length < 2 || matchData.team2.players.length < 2) {
                alert('Each team must have at least 2 players');
                return;
            }

            // Validate at least one wicketkeeper per team
            if (!matchData.team1.wicketkeeper || !matchData.team2.wicketkeeper) {
                alert('Each team must have one wicketkeeper selected');
                return;
            }

            // Get match settings
            matchData.totalOvers = parseInt(document.getElementById('total-overs').value) || 20;
            matchData.powerplayOvers = parseInt(document.getElementById('powerplay-overs').value) || 6;
            matchData.matchType = document.getElementById('match-type').value;

            // Initialize batting and bowling data
            initializeTeamData();

            // Set initial strikers and bowlers
            matchData.team1.batting[0].striker = true;
            matchData.team1.batting[1].striker = true;
            matchData.team2.bowling[0].isBowling = true;

            // Initialize partnership
            matchData.partnership = {
                runs: 0,
                balls: 0,
                batsman1: matchData.team1.batting[0].name,
                batsman2: matchData.team1.batting[1].name
            };

            matchData.matchStarted = true;
            matchData.matchEnded = false;
            matchData.currentInnings = 1;
            matchData.currentOver = [];

            // Add to timeline
            addTimelineEvent("Match started. " + matchData.team1.name + " batting first.");

            // Save match data
            saveMatchToLocalStorage();

            // Start the match
            startMatch();
        }

        function initializeTeamData() {
            // Team 1 batting
            matchData.team1.batting = matchData.team1.players.map(player => ({
                name: player,
                runs: 0,
                balls: 0,
                fours: 0,
                sixes: 0,
                out: false,
                outType: "",
                outBowler: "",
                outFielder: "",
                striker: false,
                isWicketkeeper: player === matchData.team1.wicketkeeper
            }));

            // Team 2 bowling
            matchData.team2.bowling = matchData.team2.players.map(player => ({
                name: player,
                overs: 0,
                maidens: 0,
                runs: 0,
                wickets: 0,
                balls: 0,
                isBowling: false,
                isWicketkeeper: player === matchData.team2.wicketkeeper
            }));

            // Team 2 batting
            matchData.team2.batting = matchData.team2.players.map(player => ({
                name: player,
                runs: 0,
                balls: 0,
                fours: 0,
                sixes: 0,
                out: false,
                outType: "",
                outBowler: "",
                outFielder: "",
                striker: false,
                isWicketkeeper: player === matchData.team2.wicketkeeper
            }));

            // Team 1 bowling
            matchData.team1.bowling = matchData.team1.players.map(player => ({
                name: player,
                overs: 0,
                maidens: 0,
                runs: 0,
                wickets: 0,
                balls: 0,
                isBowling: false,
                isWicketkeeper: player === matchData.team1.wicketkeeper
            }));
        }

        function startMatch() {
            setupSection.classList.add('hidden');
            matchSection.classList.remove('hidden');
            summarySection.classList.add('hidden');

            updateMatchDisplay();
        }

        function updateMatchDisplay() {
            const battingTeam = matchData.currentInnings === 1 ? matchData.team1 : matchData.team2;
            const bowlingTeam = matchData.currentInnings === 1 ? matchData.team2 : matchData.team1;

            // Update score display
            document.getElementById('current-innings').textContent = 
                matchData.currentInnings === 1 ? '1st Innings' : '2nd Innings';
            document.getElementById('score-display').textContent = 
                `${battingTeam.totalRuns}/${battingTeam.wickets} (${Math.floor(battingTeam.balls / 6)}.${battingTeam.balls % 6})`;
            
            // Update run rate
            const oversCompleted = battingTeam.balls / 6;
            const runRate = oversCompleted > 0 ? (battingTeam.totalRuns / oversCompleted).toFixed(2) : 0;
            document.getElementById('run-rate').textContent = runRate;
            
            // Update required run rate if 2nd innings
            if (matchData.currentInnings === 2) {
                const runsNeeded = matchData.team1.totalRuns - battingTeam.totalRuns + 1;
                const ballsRemaining = matchData.totalOvers * 6 - battingTeam.balls;
                const requiredRate = ballsRemaining > 0 ? ((runsNeeded / ballsRemaining) * 6).toFixed(2) : 0;
                document.getElementById('req-rate').textContent = requiredRate;
            } else {
                document.getElementById('req-rate').textContent = '-';
            }

            // Update team names
            document.getElementById('batting-team-name').textContent = battingTeam.name;
            document.getElementById('bowling-team-name').textContent = bowlingTeam.name;

            // Update partnership
            document.getElementById('partnership-runs').textContent = matchData.partnership.runs;
            document.getElementById('partnership-balls').textContent = matchData.partnership.balls;

            // Update current over display
            document.getElementById('current-over-display').textContent = 
                `${Math.floor(bowlingTeam.balls / 6)}.${bowlingTeam.balls % 6}`;

            // Update batting table
            const battingTable = document.getElementById('batting-team-players');
            battingTable.innerHTML = '';
            battingTeam.batting.forEach(player => {
                const row = document.createElement('tr');
                row.className = `border-b border-gray-100 ${player.striker ? 'active-player' : ''}`;
                row.innerHTML = `
                    <td class="py-2">${player.name} ${player.isWicketkeeper ? '(wk)' : ''} ${player.out ? `(${player.outType}${player.outBowler ? ' b ' + player.outBowler : ''}${player.outFielder ? ' c ' + player.outFielder : ''})` : player.striker ? '*' : ''}</td>
                    <td class="py-2 text-right">${player.runs}</td>
                    <td class="py-2 text-right">${player.balls}</td>
                    <td class="py-2 text-right">${player.fours}</td>
                    <td class="py-2 text-right">${player.sixes}</td>
                    <td class="py-2 text-right">${player.balls > 0 ? ((player.runs / player.balls) * 100).toFixed(1) : '-'}</td>
                `;
                battingTable.appendChild(row);
            });

            // Update bowling table
            const bowlingTable = document.getElementById('bowling-team-players');
            bowlingTable.innerHTML = '';
            bowlingTeam.bowling.forEach(player => {
                const row = document.createElement('tr');
                row.className = `border-b border-gray-100 ${player.isBowling ? 'active-player' : ''}`;
                row.innerHTML = `
                    <td class="py-2">${player.name} ${player.isWicketkeeper ? '(wk)' : ''}</td>
                    <td class="py-2 text-right">${Math.floor(player.balls / 6)}.${player.balls % 6}</td>
                    <td class="py-2 text-right">${player.maidens}</td>
                    <td class="py-2 text-right">${player.runs}</td>
                    <td class="py-2 text-right">${player.wickets}</td>
                    <td class="py-2 text-right">${player.balls > 0 ? (player.runs / (player.balls / 6)).toFixed(1) : '-'}</td>
                `;
                bowlingTable.appendChild(row);
            });

            // Update fall of wickets
            const fallOfWickets = document.getElementById('fall-of-wickets');
            fallOfWickets.innerHTML = '';
            
            const wickets = [];
            battingTeam.batting.forEach(player => {
                if (player.out) {
                    wickets.push({
                        runs: battingTeam.totalRuns,
                        player: player.name,
                        description: `${player.name} ${player.outType}${player.outBowler ? ' b ' + player.outBowler : ''}${player.outFielder ? ' c ' + player.outFielder : ''}`
                    });
                }
            });
            
            if (wickets.length > 0) {
                wickets.forEach((wicket, index) => {
                    const div = document.createElement('div');
                    div.className = 'mb-1 last:mb-0';
                    div.textContent = `${index + 1}. ${wicket.runs}-${wicket.player}: ${wicket.description}`;
                    fallOfWickets.appendChild(div);
                });
            } else {
                fallOfWickets.textContent = 'No wickets fallen yet';
            }

            // Update current over balls
            const currentOverBalls = document.getElementById('current-over-balls');
            currentOverBalls.innerHTML = '';
            
            matchData.currentOver.forEach(ball => {
                const span = document.createElement('span');
                span.className = `ball-dot ball-${ball.type}`;
                span.title = ball.description || `${ball.type.toUpperCase()}`;
                currentOverBalls.appendChild(span);
            });

            // Update striker and non-striker dropdowns
            const strikerSelect = document.getElementById('striker');
            const nonStrikerSelect = document.getElementById('non-striker');
            strikerSelect.innerHTML = '';
            nonStrikerSelect.innerHTML = '';

            battingTeam.batting.forEach(player => {
                if (!player.out) {
                    const option = document.createElement('option');
                    option.value = player.name;
                    option.textContent = player.name;
                    option.selected = player.striker;
                    strikerSelect.appendChild(option.cloneNode(true));
                    nonStrikerSelect.appendChild(option);
                }
            });

            // Update current bowler dropdown
            const bowlerSelect = document.getElementById('current-bowler');
            bowlerSelect.innerHTML = '';
            bowlingTeam.bowling.forEach(player => {
                if (!player.isWicketkeeper) { // Wicketkeepers typically don't bowl
                    const option = document.createElement('option');
                    option.value = player.name;
                    option.textContent = player.name;
                    option.selected = player.isBowling;
                    bowlerSelect.appendChild(option);
                }
            });
        }

        function addRuns(runs) {
            const battingTeam = matchData.currentInnings === 1 ? matchData.team1 : matchData.team2;
            const bowlingTeam = matchData.currentInnings === 1 ? matchData.team2 : matchData.team1;

            // Find current striker
            const striker = battingTeam.batting.find(p => p.striker);
            if (!striker || striker.out) return;

            // Update striker stats
            striker.runs += runs;
            striker.balls++;
            if (runs === 4) striker.fours++;
            if (runs === 6) striker.sixes++;

            // Update team stats
            battingTeam.totalRuns += runs;
            battingTeam.balls++;

            // Update partnership
            matchData.partnership.runs += runs;
            matchData.partnership.balls++;

            // Update bowler stats
            const currentBowler = bowlingTeam.bowling.find(p => p.isBowling);
            if (currentBowler) {
                currentBowler.runs += runs;
                currentBowler.balls++;
                
                // Check for maiden over (only if no runs scored in completed over)
                if (currentBowler.balls % 6 === 0) {
                    const overRuns = matchData.currentOver.slice(-6).reduce((sum, ball) => {
                        return sum + (ball.type === 'w' || ball.type === 'wd' || ball.type === 'nb' ? 0 : ball.runs || 0);
                    }, 0);
                    
                    if (overRuns === 0) {
                        currentBowler.maidens++;
                    }
                }
            }

            // Add ball to current over
            const commentary = document.getElementById('ball-commentary').value || "";
            matchData.currentOver.push({
                type: runs.toString(),
                runs: runs,
                striker: striker.name,
                bowler: currentBowler ? currentBowler.name : '',
                description: commentary || `${runs} run${runs !== 1 ? 's' : ''}`
            });

            // Add to timeline
            addTimelineEvent(`${striker.name} scores ${runs} run${runs !== 1 ? 's' : ''}${commentary ? ' - ' + commentary : ''}`);

            // Rotate strike if odd number of runs
            if (runs % 2 !== 0) {
                rotateStrike();
            }

            // Check for over completion
            if (bowlingTeam.balls % 6 === 0 && bowlingTeam.balls > 0) {
                completeOver();
            }

            // Check for innings end (all out or overs completed)
            checkInningsEnd();

            // Clear commentary
            document.getElementById('ball-commentary').value = "";

            // Update display
            updateMatchDisplay();
            saveMatchToLocalStorage();
        }

        function addExtra(extraType) {
            const battingTeam = matchData.currentInnings === 1 ? matchData.team1 : matchData.team2;
            const bowlingTeam = matchData.currentInnings === 1 ? matchData.team2 : matchData.team1;

            // Update team stats
            battingTeam.totalRuns += 1; // All extras count as 1 run
            battingTeam.extras += 1;

            // Update bowler stats if not a bye or leg bye
            const currentBowler = bowlingTeam.bowling.find(p => p.isBowling);
            if (currentBowler) {
                if (extraType === 'wide' || extraType === 'noball') {
                    currentBowler.runs += 1;
                }
                
                if (extraType === 'noball') {
                    battingTeam.balls--; // No ball doesn't count as a legal delivery
                } else if (extraType !== 'wide') {
                    bowlingTeam.balls++; // Byes and leg byes count as balls
                }
            }

            // Add ball to current over
            const commentary = document.getElementById('ball-commentary').value || "";
            const extraName = {
                'wide': 'WD',
                'noball': 'NB',
                'bye': 'B',
                'legbye': 'LB'
            }[extraType];
            
            matchData.currentOver.push({
                type: extraType,
                runs: 1,
                striker: '',
                bowler: currentBowler ? currentBowler.name : '',
                description: `${extraName}${commentary ? ' - ' + commentary : ''}`
            });

            // Add to timeline
            addTimelineEvent(`${extraName} called${commentary ? ' - ' + commentary : ''}`);

            // Check for over completion (wides and no-balls don't count toward over)
            if (extraType === 'wide' || extraType === 'noball') {
                if (bowlingTeam.balls % 6 === 0 && bowlingTeam.balls > 0) {
                    completeOver();
                }
            }

            // Clear commentary
            document.getElementById('ball-commentary').value = "";

            // Update display
            updateMatchDisplay();
            saveMatchToLocalStorage();
        }

        function addWicket(wicketType) {
            const battingTeam = matchData.currentInnings === 1 ? matchData.team1 : matchData.team2;
            const bowlingTeam = matchData.currentInnings === 1 ? matchData.team2 : matchData.team1;

            // Find current striker
            const striker = battingTeam.batting.find(p => p.striker);
            if (!striker || striker.out) return;

            // Update striker stats
            striker.out = true;
            striker.outType = wicketType;
            
            // Set bowler and fielder based on wicket type
            const currentBowler = bowlingTeam.bowling.find(p => p.isBowling);
            const fieldingPosition = document.getElementById('fielding-position').value;
            const commentary = document.getElementById('ball-commentary').value || "";
            
            if (wicketType !== 'runout') {
                if (currentBowler) {
                    striker.outBowler = currentBowler.name;
                    currentBowler.wickets++;
                }
                
                if (wicketType === 'caught' || wicketType === 'stumped') {
                    striker.outFielder = fieldingPosition || (wicketType === 'stumped' ? bowlingTeam.wicketkeeper : 'unknown');
                }
            } else {
                striker.outFielder = fieldingPosition || 'unknown';
            }

            // Update team stats
            battingTeam.wickets++;
            battingTeam.balls++;

            // Update bowler stats
            if (currentBowler && wicketType !== 'runout') {
                currentBowler.balls++;
                
                // Check for maiden over
                if (currentBowler.balls % 6 === 0) {
                    const overRuns = matchData.currentOver.slice(-6).reduce((sum, ball) => {
                        return sum + (ball.type === 'w' || ball.type === 'wd' || ball.type === 'nb' ? 0 : ball.runs || 0);
                    }, 0);
                    
                    if (overRuns === 0) {
                        currentBowler.maidens++;
                    }
                }
            }

            // Reset partnership
            matchData.partnership = {
                runs: 0,
                balls: 0,
                batsman1: "",
                batsman2: ""
            };

            // Add ball to current over
            matchData.currentOver.push({
                type: 'w',
                runs: 0,
                striker: striker.name,
                bowler: currentBowler ? currentBowler.name : '',
                fielder: striker.outFielder || '',
                description: `Wicket! ${striker.name} ${wicketType}${currentBowler ? ' b ' + currentBowler.name : ''}${striker.outFielder ? ' c ' + striker.outFielder : ''}${commentary ? ' - ' + commentary : ''}`
            });

            // Add to timeline
            addTimelineEvent(`Wicket! ${striker.name} ${wicketType}${currentBowler ? ' b ' + currentBowler.name : ''}${striker.outFielder ? ' c ' + striker.outFielder : ''}${commentary ? ' - ' + commentary : ''}`);

            // Find next batsman
            const nextBatsman = battingTeam.batting.find(p => !p.out && !p.striker);
            if (nextBatsman) {
                nextBatsman.striker = true;
                
                // Update partnership
                const nonStriker = battingTeam.batting.find(p => p.striker && p.name !== nextBatsman.name);
                if (nonStriker) {
                    matchData.partnership = {
                        runs: 0,
                        balls: 0,
                        batsman1: nextBatsman.name,
                        batsman2: nonStriker.name
                    };
                }
            }

            // Check for over completion
            if (bowlingTeam.balls % 6 === 0 && bowlingTeam.balls > 0) {
                completeOver();
            }

            // Check for innings end (all out or overs completed)
            checkInningsEnd();

            // Clear commentary
            document.getElementById('ball-commentary').value = "";

            // Update display
            updateMatchDisplay();
            saveMatchToLocalStorage();
        }

        function rotateStrike() {
            const battingTeam = matchData.currentInnings === 1 ? matchData.team1 : matchData.team2;
            battingTeam.batting.forEach(player => {
                if (!player.out) {
                    player.striker = !player.striker;
                }
            });
            
            // Update partnership
            const strikers = battingTeam.batting.filter(p => p.striker && !p.out);
            if (strikers.length === 2) {
                matchData.partnership.batsman1 = strikers[0].name;
                matchData.partnership.batsman2 = strikers[1].name;
            }
            
            updateMatchDisplay();
            saveMatchToLocalStorage();
        }

        function changeBowler() {
            const bowlingTeam = matchData.currentInnings === 1 ? matchData.team2 : matchData.team1;
            const newBowlerName = document.getElementById('current-bowler').value;
            
            // Find current bowler and set to not bowling
            const currentBowler = bowlingTeam.bowling.find(p => p.isBowling);
            if (currentBowler) {
                currentBowler.isBowling = false;
            }
            
            // Set new bowler
            const newBowler = bowlingTeam.bowling.find(p => p.name === newBowlerName);
            if (newBowler) {
                newBowler.isBowling = true;
                
                // Add to timeline
                addTimelineEvent(`Bowler changed to ${newBowlerName}`);
            }
            
            updateMatchDisplay();
            saveMatchToLocalStorage();
        }

        function completeOver() {
            const bowlingTeam = matchData.currentInnings === 1 ? matchData.team2 : matchData.team1;
            
            // Rotate strike at the end of the over (unless odd number of runs on last ball)
            const lastBall = matchData.currentOver[matchData.currentOver.length - 1];
            if (!lastBall || !['1', '3', 'wide', 'noball'].includes(lastBall.type)) {
                rotateStrike();
            }
            
            // Reset current over
            matchData.currentOver = [];
            
            // Add to timeline
            addTimelineEvent(`Over completed. ${Math.floor(bowlingTeam.balls / 6)}.${bowlingTeam.balls % 6} overs bowled`);
            
            updateMatchDisplay();
            saveMatchToLocalStorage();
        }

        function checkInningsEnd() {
            const battingTeam = matchData.currentInnings === 1 ? matchData.team1 : matchData.team2;
            
            // Check if all out (all players except one)
            if (battingTeam.wickets >= battingTeam.players.length - 1) {
                endInnings();
                return;
            }

            // Check if overs completed
            if (battingTeam.balls >= matchData.totalOvers * 6) {
                endInnings();
                return;
            }
        }

        function endInnings() {
            const battingTeam = matchData.currentInnings === 1 ? matchData.team1 : matchData.team2;
            const bowlingTeam = matchData.currentInnings === 1 ? matchData.team2 : matchData.team1;
            
            // Complete current over
            const currentBowler = bowlingTeam.bowling.find(p => p.isBowling);
            if (currentBowler && currentBowler.balls % 6 !== 0) {
                currentBowler.overs += (currentBowler.balls % 6) / 6;
                currentBowler.balls = Math.floor(currentBowler.balls / 6) * 6;
            }

            // Add to timeline
            addTimelineEvent(`Innings ended. ${battingTeam.name} ${battingTeam.totalRuns}/${battingTeam.wickets} in ${Math.floor(battingTeam.balls / 6)}.${battingTeam.balls % 6} overs`);

            // Check if match should end (2nd innings completed)
            if (matchData.currentInnings === 2) {
                matchData.matchEnded = true;
                showSummary();
            } else {
                // Switch to 2nd innings
                matchData.currentInnings = 2;
                
                // Reset striker and bowler
                matchData.team2.batting[0].striker = true;
                matchData.team2.batting[1].striker = true;
                matchData.team1.bowling.forEach((bowler, i) => {
                    bowler.isBowling = i === 0;
                });

                // Reset partnership
                matchData.partnership = {
                    runs: 0,
                    balls: 0,
                    batsman1: matchData.team2.batting[0].name,
                    batsman2: matchData.team2.batting[1].name
                };

                // Reset current over
                matchData.currentOver = [];

                // Add to timeline
                addTimelineEvent(`${matchData.team2.name} needs ${matchData.team1.totalRuns + 1} runs to win`);

                updateMatchDisplay();
            }

            saveMatchToLocalStorage();
        }

        function showSummary() {
            matchSection.classList.add('hidden');
            summarySection.classList.remove('hidden');

            // Update team names
            document.getElementById('summary-team1-name').textContent = matchData.team1.name;
            document.getElementById('summary-team2-name').textContent = matchData.team2.name;

            // Update team 1 batting
            const team1Batting = document.getElementById('summary-team1-batting');
            team1Batting.innerHTML = '';
            matchData.team1.batting.forEach(player => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-100';
                row.innerHTML = `
                    <td class="py-2">${player.name} ${player.isWicketkeeper ? '(wk)' : ''} ${player.out ? `(${player.outType}${player.outBowler ? ' b ' + player.outBowler : ''}${player.outFielder ? ' c ' + player.outFielder : ''})` : 'not out'}</td>
                    <td class="py-2 text-right">${player.runs}</td>
                    <td class="py-2 text-right">${player.balls}</td>
                    <td class="py-2 text-right">${player.fours}</td>
                    <td class="py-2 text-right">${player.sixes}</td>
                    <td class="py-2 text-right">${player.balls > 0 ? ((player.runs / player.balls) * 100).toFixed(1) : '-'}</td>
                `;
                team1Batting.appendChild(row);
            });

            // Update team 2 bowling
            const team2Bowling = document.getElementById('summary-team2-bowling');
            team2Bowling.innerHTML = '';
            matchData.team2.bowling.forEach(player => {
                if (player.balls > 0) {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-100';
                    row.innerHTML = `
                        <td class="py-2">${player.name} ${player.isWicketkeeper ? '(wk)' : ''}</td>
                        <td class="py-2 text-right">${Math.floor(player.balls / 6)}.${player.balls % 6}</td>
                        <td class="py-2 text-right">${player.maidens}</td>
                        <td class="py-2 text-right">${player.runs}</td>
                        <td class="py-2 text-right">${player.wickets}</td>
                        <td class="py-2 text-right">${player.balls > 0 ? (player.runs / (player.balls / 6)).toFixed(1) : '-'}</td>
                    `;
                    team2Bowling.appendChild(row);
                }
            });

            // Update team 2 batting
            const team2Batting = document.getElementById('summary-team2-batting');
            team2Batting.innerHTML = '';
            matchData.team2.batting.forEach(player => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-100';
                row.innerHTML = `
                    <td class="py-2">${player.name} ${player.isWicketkeeper ? '(wk)' : ''} ${player.out ? `(${player.outType}${player.outBowler ? ' b ' + player.outBowler : ''}${player.outFielder ? ' c ' + player.outFielder : ''})` : 'not out'}</td>
                    <td class="py-2 text-right">${player.runs}</td>
                    <td class="py-2 text-right">${player.balls}</td>
                    <td class="py-2 text-right">${player.fours}</td>
                    <td class="py-2 text-right">${player.sixes}</td>
                    <td class="py-2 text-right">${player.balls > 0 ? ((player.runs / player.balls) * 100).toFixed(1) : '-'}</td>
                `;
                team2Batting.appendChild(row);
            });

            // Update team 1 bowling
            const team1Bowling = document.getElementById('summary-team1-bowling');
            team1Bowling.innerHTML = '';
            matchData.team1.bowling.forEach(player => {
                if (player.balls > 0) {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-100';
                    row.innerHTML = `
                        <td class="py-2">${player.name} ${player.isWicketkeeper ? '(wk)' : ''}</td>
                        <td class="py-2 text-right">${Math.floor(player.balls / 6)}.${player.balls % 6}</td>
                        <td class="py-2 text-right">${player.maidens}</td>
                        <td class="py-2 text-right">${player.runs}</td>
                        <td class="py-2 text-right">${player.wickets}</td>
                        <td class="py-2 text-right">${player.balls > 0 ? (player.runs / (player.balls / 6)).toFixed(1) : '-'}</td>
                    `;
                    team1Bowling.appendChild(row);
                }
            });

            // Update result
            const resultElement = document.getElementById('match-result');
            const summaryElement = document.getElementById('match-summary');
            
            if (matchData.team1.totalRuns > matchData.team2.totalRuns) {
                const margin = matchData.team1.totalRuns - matchData.team2.totalRuns;
                resultElement.textContent = `${matchData.team1.name} won by ${margin} run${margin !== 1 ? 's' : ''}`;
                summaryElement.textContent = `${matchData.team1.name} scored ${matchData.team1.totalRuns}/${matchData.team1.wickets} in ${Math.floor(matchData.team1.balls / 6)}.${matchData.team1.balls % 6} overs. ${matchData.team2.name} scored ${matchData.team2.totalRuns}/${matchData.team2.wickets} in ${Math.floor(matchData.team2.balls / 6)}.${matchData.team2.balls % 6} overs.`;
            } else if (matchData.team2.totalRuns > matchData.team1.totalRuns) {
                const wicketsLeft = matchData.team2.players.length - 1 - matchData.team2.wickets;
                resultElement.textContent = `${matchData.team2.name} won by ${wicketsLeft} wicket${wicketsLeft !== 1 ? 's' : ''}`;
                summaryElement.textContent = `${matchData.team2.name} chased ${matchData.team1.totalRuns} in ${Math.floor(matchData.team2.balls / 6)}.${matchData.team2.balls % 6} overs, losing ${matchData.team2.wickets} wicket${matchData.team2.wickets !== 1 ? 's' : ''}.`;
            } else {
                resultElement.textContent = "Match tied";
                summaryElement.textContent = `Both teams scored ${matchData.team1.totalRuns} runs.`;
            }

            // Update timeline
            const timelineElement = document.getElementById('match-timeline');
            timelineElement.innerHTML = '';
            
            matchData.timeline.forEach(event => {
                const div = document.createElement('div');
                div.className = 'mb-1 last:mb-0 text-sm';
                div.textContent = event;
                timelineElement.appendChild(div);
            });
        }

        function undoLastAction() {
            if (matchData.history.length === 0) return;

            const lastAction = matchData.history.pop();
            const battingTeam = matchData.currentInnings === 1 ? matchData.team1 : matchData.team2;
            const bowlingTeam = matchData.currentInnings === 1 ? matchData.team2 : matchData.team1;

            if (lastAction.type === 'runs') {
                // Undo runs
                const striker = battingTeam.batting.find(p => p.name === lastAction.striker);
                if (striker) {
                    striker.runs -= lastAction.runs;
                    striker.balls--;
                    if (lastAction.runs === 4) striker.fours--;
                    if (lastAction.runs === 6) striker.sixes--;
                }

                battingTeam.totalRuns -= lastAction.runs;
                battingTeam.balls--;

                // Update partnership
                matchData.partnership.runs -= lastAction.runs;
                matchData.partnership.balls--;

                const bowler = bowlingTeam.bowling.find(p => p.name === lastAction.bowler);
                if (bowler) {
                    bowler.runs -= lastAction.runs;
                    bowler.balls--;
                    if (bowler.balls % 6 === 0) {
                        bowler.overs--;
                    }
                }

                // Remove last ball from current over
                matchData.currentOver.pop();

                // Undo strike rotation if odd runs
                if (lastAction.runs % 2 !== 0) {
                    rotateStrike();
                }
            } else if (lastAction.type === 'extra') {
                // Undo extra
                battingTeam.totalRuns--;
                battingTeam.extras--;

                const bowler = bowlingTeam.bowling.find(p => p.name === lastAction.bowler);
                if (bowler) {
                    if (lastAction.extraType === 'wide' || lastAction.extraType === 'noball') {
                        bowler.runs--;
                    }
                    
                    if (lastAction.extraType === 'noball') {
                        battingTeam.balls++;
                    } else if (lastAction.extraType !== 'wide') {
                        bowlingTeam.balls--;
                    }
                }

                // Remove last ball from current over
                matchData.currentOver.pop();
            } else if (lastAction.type === 'wicket') {
                // Undo wicket
                const batsman = battingTeam.batting.find(p => p.name === lastAction.batsman);
                if (batsman) {
                    batsman.out = false;
                    batsman.outType = "";
                    batsman.outBowler = "";
                    batsman.outFielder = "";
                }

                battingTeam.wickets--;
                battingTeam.balls--;

                const bowler = bowlingTeam.bowling.find(p => p.name === lastAction.bowler);
                if (bowler && lastAction.wicketType !== 'runout') {
                    bowler.wickets--;
                    bowler.balls--;
                    if (bowler.balls % 6 === 0) {
                        bowler.overs--;
                    }
                }

                // Restore partnership
                const strikers = battingTeam.batting.filter(p => p.striker && !p.out);
                if (strikers.length === 2) {
                    matchData.partnership = {
                        runs: lastAction.partnershipRuns,
                        balls: lastAction.partnershipBalls,
                        batsman1: strikers[0].name,
                        batsman2: strikers[1].name
                    };
                }

                // Remove last ball from current over
                matchData.currentOver.pop();

                // Find who was batting before and restore
                const currentStrikers = battingTeam.batting.filter(p => p.striker);
                if (currentStrikers.length === 1) {
                    // Only one striker, need to find who was out
                    const outPlayer = battingTeam.batting.find(p => p.name === lastAction.batsman);
                    if (outPlayer) {
                        outPlayer.striker = true;
                    }
                }
            }

            // Remove last timeline event
            matchData.timeline.pop();

            updateMatchDisplay();
            saveMatchToLocalStorage();
        }

        function resetMatch() {
            if (confirm('Are you sure you want to start a new match? All current data will be lost.')) {
                matchData = {
                    team1: {
                        name: "",
                        players: [],
                        batting: [],
                        bowling: [],
                        totalRuns: 0,
                        wickets: 0,
                        overs: 0,
                        balls: 0,
                        extras: 0,
                        wicketkeeper: ""
                    },
                    team2: {
                        name: "",
                        players: [],
                        batting: [],
                        bowling: [],
                        totalRuns: 0,
                        wickets: 0,
                        overs: 0,
                        balls: 0,
                        extras: 0,
                        wicketkeeper: ""
                    },
                    currentInnings: 1,
                    totalOvers: 20,
                    powerplayOvers: 6,
                    matchType: "limited",
                    history: [],
                    timeline: [],
                    matchStarted: false,
                    matchEnded: false,
                    currentOver: [],
                    partnership: {
                        runs: 0,
                        balls: 0,
                        batsman1: "",
                        batsman2: ""
                    }
                };

                // Reset form
                document.getElementById('team1-name').value = '';
                document.getElementById('team2-name').value = '';
                document.getElementById('team1-players').innerHTML = `
                    <div class="flex gap-2 items-center">
                        <input type="text" class="flex-1 px-3 py-2 border border-gray-300 rounded-md" placeholder="Player name">
                        <div class="flex items-center gap-2">
                            <label class="text-xs text-gray-500">WK</label>
                            <input type="checkbox" class="wicketkeeper">
                        </div>
                        <button class="remove-player px-2 py-1 bg-red-100 text-red-700 rounded-md text-sm">×</button>
                    </div>
                `;
                document.getElementById('team2-players').innerHTML = `
                    <div class="flex gap-2 items-center">
                        <input type="text" class="flex-1 px-3 py-2 border border-gray-300 rounded-md" placeholder="Player name">
                        <div class="flex items-center gap-2">
                            <label class="text-xs text-gray-500">WK</label>
                            <input type="checkbox" class="wicketkeeper">
                        </div>
                        <button class="remove-player px-2 py-1 bg-red-100 text-red-700 rounded-md text-sm">×</button>
                    </div>
                `;
                document.getElementById('total-overs').value = '20';
                document.getElementById('powerplay-overs').value = '6';
                document.getElementById('match-type').value = 'limited';

                // Show setup section
                setupSection.classList.remove('hidden');
                matchSection.classList.add('hidden');
                summarySection.classList.add('hidden');

                // Clear saved match
                localStorage.removeItem('cricketMatchData');
            }
        }

        function saveMatch() {
            saveMatchToLocalStorage();
            alert('Match data saved successfully! You can load it later.');
        }

        function loadMatch() {
            const savedMatch = localStorage.getItem('cricketMatchData');
            if (savedMatch) {
                try {
                    const parsedData = JSON.parse(savedMatch);
                    if (parsedData.matchStarted) {
                        matchData = parsedData;
                        if (matchData.matchEnded) {
                            showSummary();
                        } else {
                            startMatch();
                        }
                        return;
                    }
                } catch (e) {
                    console.error("Error loading saved match:", e);
                }
            }
            alert('No saved match found or error loading match.');
        }

        function exportMatch() {
            const dataStr = JSON.stringify(matchData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `cricket_match_${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function saveMatchToLocalStorage() {
            localStorage.setItem('cricketMatchData', JSON.stringify(matchData));
        }

        function addTimelineEvent(event) {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            matchData.timeline.push(`[${timeString}] ${event}`);
        }
    </script>
</body>
</html>